<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>PBSF – Lista de Compras Pro</title>
<meta name="theme-color" content="#1f7ae0">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
:root{
  --bg:#0c1118; --panel:#121826; --panel-2:#0e1523; --line:#1f2a3a;
  --text:#e7ecf3; --muted:#96a2b4; --accent:#1f7ae0; --accent-2:#11b1e2;
  --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  --radius:14px;
}
@media (prefers-color-scheme: light){
  :root{ --bg:#f6f8fc; --panel:#ffffff; --panel-2:#f1f5fb; --line:#e3e9f3; --text:#0b1220; --muted:#657089 }
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); background:var(--bg);}

/* Desktop / tablet */
.container{max-width:1280px;margin:0 auto;padding:28px 16px 120px}
.head{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:12px}
.brand img{width:44px;height:44px;border-radius:12px;border:1px solid var(--line);background:#0b1117;object-fit:cover}
h1{margin:0;font-size:clamp(20px,2.7vw,30px);line-height:1.2;font-weight:800;letter-spacing:.2px}
.sub{font-size:12px;color:var(--muted)}
.toolbar{display:flex;gap:10px;flex-wrap:wrap}
.btn{border:1px solid var(--line);background:var(--panel);color:var(--text);min-height:44px;padding:10px 14px;border-radius:12px;font-size:14px;line-height:1;cursor:pointer}
.btn:hover{background:rgba(255,255,255,.02)}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:0;color:#fff;box-shadow:0 6px 16px rgba(31,122,224,.32)}
.btn.danger{background:#c63a3a;border:0;color:#fff}
.btn.ghost{background:transparent}
.card{background:var(--panel);border:1px solid var(--line);border-radius:18px;overflow:hidden}
.card-inner{padding:16px}

/* Linha de adicionar (desktop) */
.grid{
  display:grid;
  column-gap:16px;
  row-gap:12px;
  grid-template-columns: 1fr 120px 250px 260px; /* nome | qtd | preço | botão */
}
#btnAdd{ min-width:260px; border-radius:12px; }

.input{min-height:44px;border:1px solid var(--line);border-radius:12px;padding:0 12px;background:transparent;color:inherit;outline:none;line-height:1.15}
.input::placeholder{color:var(--muted)}
.input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(31,122,224,.25)}
.price{position:relative}
.price .prefix{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--muted)}
.price input{padding-left:26px;text-align:right;width:100%}

.row{display:grid;gap:12px;grid-template-columns:1fr auto;align-items:center;margin-top:12px}
.badges{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.badge{display:inline-flex;align-items:center;min-height:32px;padding:0 12px;border-radius:999px;border:1px solid var(--line);background:var(--panel-2);font-size:12px;line-height:1}
.badge.ok{background:#133b2a;color:#8de0b9;border-color:#1b513b}
.badge.warn{background:#3c2d14;color:#f1c27c;border-color:#5a411b}

.seg{display:flex;overflow:hidden;border:1px solid var(--line);border-radius:12px}
.seg button{min-height:40px;padding:0 14px;border:0;background:transparent;color:inherit;cursor:pointer;line-height:1}
.seg button.active{background:var(--panel-2)}

/* Lista */
.list{display:flex;flex-direction:column;gap:8px;margin-top:16px}

/* CARD DO ITEM: nome em cima, controles embaixo */
.item{
  display:grid;
  grid-template-columns: 1fr;        /* uma coluna */
  gap:8px;
  align-items:start;
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:16px;
  padding:10px 12px;
  overflow:hidden;
}

/* Linha de cima: checkbox + nome */
.left{display:flex;gap:12px;align-items:center}
.left input[type=checkbox]{width:18px;height:18px;accent-color:#22c55e}
.name{
  flex:1;
  width:100%;
  border:1px solid transparent;
  border-radius:10px;
  background:transparent;
  color:inherit;
  padding:8px 10px;
  font-size:16px; line-height:1.2;
}
.name:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(31,122,224,.25)}

/* Linha de baixo: controles ocupam a largura */
.right{
  display:grid;
  grid-template-columns: max-content max-content max-content 1fr max-content; /* chip | qtd | unit | (espaçador) | remover */
  align-items:center;
  column-gap:10px;
  row-gap:6px;
    justify-self:start;   /* antes esticava */
}

/* Controles */
.chip{display:inline-flex;align-items:center;min-height:26px;padding:0 10px;border-radius:999px;border:1px solid var(--line);line-height:1;font-size:12px}
.chip.pago{background:#133b2a;color:#8de0b9;border-color:#1b513b}
.chip.pendente{background:#3c2d14;color:#f1c27c;border-color:#5a411b}
.pill{display:flex;align-items:center;gap:6px}
.qty{display:inline-flex;align-items:stretch;border:1px solid var(--line);border-radius:10px;overflow:hidden}
.qty button{border:0;background:transparent;width:32px;min-height:32px;color:inherit;cursor:pointer;line-height:1}
.qty input{width:60px;text-align:center;border-left:1px solid var(--line);border-right:1px solid var(--line);background:transparent;color:inherit;min-height:32px}
.unit{position:relative}
.unit span{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--muted)}
.unit input{min-height:32px;width:110px;border:1px solid var(--line);border-radius:10px;background:transparent;color:inherit;padding-left:22px;text-align:right}

/* >>> TOTAL MENOR E SEM ESTICAR <<< */
.total{
  display:inline-flex;
  align-items:center;
  min-height:30px;         /* altura menor */
  padding:0 10px;           /* menos espaço lateral */
  border-radius:10px;       /* borda menor */
  background:var(--panel-2);
  border:1px solid var(--line);
  font-weight:600;
  font-size:12px;          /* fonte menor */
  line-height:1;
  justify-self:start;      /* NÃO estica: fica do tamanho do conteúdo */
}

.btn.remove{background:#2a1416;border:1px solid #80333a;color:#fda4af;padding:10px 12px}
.btn.remove:hover{filter:brightness(1.05)}

.footer{position:sticky;bottom:18px;margin-top:18px;background:rgba(0,0,0,.25);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:16px;padding:12px 16px}
.end{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.muted{color:var(--muted)}
.empty{text-align:center;color:var(--muted);border:1px dashed var(--line);border-radius:16px;padding:28px;margin-top:14px}
.compact .item{padding:8px 10px}
.compact .name{font-size:15px}
.compact .qty input{width:54px}

/* ====== MOBILE (<= 760px) ====== */
@media (max-width:760px){
  .container{padding:16px 12px 110px}
  .grid{grid-template-columns:1fr; row-gap:10px}
  #btnAdd{width:100%; min-width:0}

  .row{grid-template-columns:1fr}
  .toolbar{gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:6px}

  .right{grid-template-columns: 1fr; }
  .right .chip{justify-self:start}
  .pill{justify-content:space-between}
  .qty{width:100%}
  .qty input{width:100%; min-width:0}
  .unit input{width:100%}
  .total{width:100%; justify-content:center; justify-self:stretch;}
  .btn.remove{width:100%}
  .badges{gap:6px}
}
</style>
</head>
<body>
  <div class="container">
    <header class="head">
      <div class="brand">
        <img src="logo_cart.png" alt="Carrinho">
        <div>
          <h1>Lista de Compras Pro</h1>
          <div class="sub">Prime Brain Systens & Future</div>
        </div>
      </div>
      <div class="toolbar">
        <button id="btnTheme" class="btn">Tema</button>
        <button id="btnCompact" class="btn">Compacto</button>
        <button id="btnExportJSON" class="btn">Exportar JSON</button>
        <button id="btnExportCSV" class="btn">Exportar CSV</button>
        <label class="btn ghost" style="cursor:pointer">Importar JSON
          <input id="fileImport" type="file" accept="application/json" style="display:none">
        </label>
      </div>
    </header>

    <section class="card">
      <div class="card-inner">
        <div class="grid">
          <input id="inpNome" class="input" placeholder="Produto (ex.: Arroz)">
          <input id="inpQtd" class="input" type="number" min="1" value="1" placeholder="Qtd">
          <div class="price"><span class="prefix">R$</span>
            <input id="inpUnit" class="input" type="number" min="0" step="0.01" placeholder="Preço unitário">
          </div>
          <button id="btnAdd" class="btn primary">Adicionar</button>
        </div>

        <div class="row">
          <div class="badges" id="badges"></div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div class="seg">
              <button id="segTodos" class="active">Todos</button>
              <button id="segPend">Pendentes</button>
              <button id="segPago">Pagos</button>
            </div>
            <input id="inpBusca" class="input" placeholder="Pesquisar produto" style="min-height:40px;width:240px">
            <button id="btnClearPaid" class="btn">Limpar pagos</button>
            <button id="btnClearAll" class="btn danger">Apagar tudo</button>
          </div>
        </div>
      </div>
    </section>

    <div id="list" class="list"></div>
    <div id="empty" class="empty" style="display:none">Comece adicionando produtos acima…</div>

    <footer id="footer" class="footer" style="display:none">
      <div class="end">
        <div class="badges" id="badges2"></div>
        <div class="muted" style="font-size:12px"> <b></b> </div>
      </div>
    </footer>
  </div>

<script>
const STORE_KEY = 'listaCompras';
let items = [];
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

function load(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(raw) items = JSON.parse(raw) || [];
  }catch(_){ items = []; }
  items = items.map(i => ({
    id: i.id ?? Date.now()+Math.random(),
    name: i.name ?? i.nome ?? '',
    qty: Number(i.qty ?? i.quantidade ?? 1),
    done: !!(i.done ?? (i.status==='pago')),
    price: (i.price===null || typeof i.price==='number') ? i.price : null
  }));
  render();
}
function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(items)); }
function brl(n){ return (n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
let filtro='todos', busca='';

function summary(){
  const sum = arr => arr.reduce((a,i)=>a+(Number(i.qty||1)*Number(i.price||0)),0);
  const geral=sum(items), pend=sum(items.filter(i=>!i.done)), pago=sum(items.filter(i=>i.done));
  return { geral, pend, pago, itens: items.length, pendQt: items.filter(i=>!i.done).length, pagoQt: items.filter(i=>i.done).length };
}
function badgesTop(){
  const s=summary();
  return [
    `<span class="badge">Itens: ${s.itens}</span>`,
    `<span class="badge warn">Pendentes: ${s.pendQt}</span>`,
    `<span class="badge ok">Pagos: ${s.pagoQt}</span>`,
    `<span class="badge">Total: ${brl(s.geral)}</span>`
  ].join('');
}
function renderBadges(){
  $('#badges').innerHTML = badgesTop();
  const s=summary();
  $('#badges2').innerHTML = [
    `<span class="badge">Geral: ${brl(s.geral)}</span>`,
    `<span class="badge warn">Pendentes: ${brl(s.pend)}</span>`,
    `<span class="badge ok">Pagos: ${brl(s.pago)}</span>`
  ].join('');
}
function visible(){
  return items.filter(i=>{
    if(filtro==='pendente' && i.done) return false;
    if(filtro==='pago' && !i.done) return false;
    if(busca && !(`${i.qty}x ${i.name}`.toLowerCase().includes(busca))) return false;
    return true;
  });
}
function render(){
  renderBadges();
  const list = $('#list'); list.innerHTML='';
  const vis = visible();
  $('#empty').style.display = vis.length? 'none' : 'block';
  $('#footer').style.display = items.length? 'block' : 'none';
  vis.forEach(it => list.appendChild(renderItem(it)));
}

function renderItem(it){
  const row = document.createElement('div'); row.className='item';

  /* Linha de cima: checkbox + nome */
  const left = document.createElement('div'); left.className='left';
  const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=!!it.done;
  cb.onchange = ()=>{ it.done = cb.checked; save(); render(); };
  const name = document.createElement('input'); name.value = it.name; name.className='name'; name.placeholder='Produto';
  name.oninput = ()=>{ it.name = name.value; save(); };
  left.append(cb,name);

  /* Linha de baixo: controles em grade */
  const right = document.createElement('div'); right.className='right';
  const chip = document.createElement('span'); chip.className = 'chip ' + (it.done? 'pago':'pendente'); chip.textContent = it.done? 'Pago':'Pendente';
  right.appendChild(chip);

  const pillQtd = document.createElement('div'); pillQtd.className='pill'; pillQtd.innerHTML='<span class="muted" style="font-size:12px">Qtd</span>';
  const qty = document.createElement('div'); qty.className = 'qty';
  const bM = document.createElement('button'); bM.textContent='−';
  const qI = document.createElement('input'); qI.type='number'; qI.min='1'; qI.value = it.qty || 1;
  const bP = document.createElement('button'); bP.textContent='+';
  bM.onclick=()=>{ it.qty = Math.max(1, Number(qI.value)-1); qI.value = it.qty; save(); render(); };
  bP.onclick=()=>{ it.qty = Number(qI.value)+1; qI.value = it.qty; save(); render(); };
  qI.oninput=()=>{ it.qty = Math.max(1, Number(qI.value||1)); save(); render(); };
  qty.append(bM,qI,bP); pillQtd.appendChild(qty); right.appendChild(pillQtd);

  const pillUnit = document.createElement('div'); pillUnit.className='pill'; pillUnit.innerHTML='<span class="muted" style="font-size:12px">Unitário</span>';
  const unit = document.createElement('div'); unit.className='unit';
  unit.innerHTML = '<span>R$</span>';
  const uI = document.createElement('input'); uI.type='number'; uI.min='0'; uI.step='0.01'; uI.value = (typeof it.price==='number'? it.price : 0);
  uI.oninput=()=>{ it.price = Number(uI.value||0); save(); renderBadges(); updateTotal(); };
  unit.appendChild(uI); pillUnit.appendChild(unit); right.appendChild(pillUnit);

  const total = document.createElement('span'); total.className='total';
  function updateTotal(){ total.textContent = 'Total: ' + brl((Number(it.qty||1) * Number(it.price||0))); }
  updateTotal(); right.appendChild(total);

  const rm = document.createElement('button'); rm.className='btn remove'; rm.textContent='Remover';
  rm.onclick = ()=>{ items = items.filter(x=>x!==it); save(); render(); };
  right.appendChild(rm);

  row.append(left,right);
  return row;
}

// Top actions
document.getElementById('btnAdd').onclick = ()=>{
  const nome = document.getElementById('inpNome').value.trim();
  const qtd = Math.max(1, Number(document.getElementById('inpQtd').value||1));
  const unit = Number(document.getElementById('inpUnit').value||0);
  if(!nome){
    document.getElementById('inpNome').focus();
    return;
  }
  items.unshift({ id: Date.now(), name:nome, qty:qtd, done:false, price: isFinite(unit)? unit:0 });
  save(); render();
  document.getElementById('inpNome').value='';
  document.getElementById('inpQtd').value=1;
  document.getElementById('inpUnit').value='';
  document.getElementById('inpNome').focus();
};

document.getElementById('btnClearAll').onclick = ()=>{
  if(confirm('Apagar toda a lista?')){ items=[]; save(); render(); }
};
document.getElementById('btnClearPaid').onclick = ()=>{ items = items.filter(i=>!i.done); save(); render(); };
document.getElementById('segTodos').onclick=()=>{ setSeg('segTodos'); filtro='todos'; render(); };
document.getElementById('segPend').onclick=()=>{ setSeg('segPend'); filtro='pendente'; render(); };
document.getElementById('segPago').onclick=()=>{ setSeg('segPago'); filtro='pago'; render(); };
function setSeg(id){ $$('.seg button').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); }
document.getElementById('inpBusca').oninput = e => { busca = (e.target.value||'').toLowerCase().trim(); render(); };

// Export/Import
document.getElementById('btnExportJSON').onclick=()=>{
  const blob = new Blob([JSON.stringify(items,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='lista-compras.json'; a.click();
  URL.revokeObjectURL(url);
};
document.getElementById('btnExportCSV').onclick=()=>{
  const header=['Produto','Quantidade','Preço Unitário','Total','Status'];
  const rows=items.map(i=>[
    i.name,
    i.qty,
    String(i.price??0).replace('.',','),
    String((i.qty||0)*(i.price||0)).replace('.',','),
    i.done?'pago':'pendente'
  ]);
  const csv=[header,...rows].map(r=>r.join(';')).join('\n');
  const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='lista-compras.csv'; a.click();
  URL.revokeObjectURL(url);
};
document.getElementById('fileImport').onchange = ev => {
  const f=ev.target.files?.[0]; if(!f)return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(String(r.result));
      if(Array.isArray(data)){ items=data; save(); render(); }
    }catch(_){}
  };
  r.readAsText(f);
};

// Tema e compacto
document.getElementById('btnTheme').onclick = ()=>{
  const cur=document.documentElement.getAttribute('data-theme');
  document.documentElement.setAttribute('data-theme', cur==='light'?'dark':'light');
};
document.getElementById('btnCompact').onclick = ()=>{ document.body.classList.toggle('compact'); };

if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
load();
</script>
</body>
</html>
